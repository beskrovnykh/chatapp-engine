## Оглавление

### Контекст

Наши новые пользователи, хотят иметь возможность более гибко настраивать чат-ботов. Также у нас появляются новые пользователи, которые хотят иметь возможность встраивать чат-ботов в свои бизнес-процессы, сделанные в BPMN.
По этой причине мы хотим предоставить нашим пользователям возможность создавать чат-ботов визуально в нотации BPMN или аналогичной по содержанию

### Задача

Для этого нам нужно выбрать существующих фреймворки для бэк-энда и фронт-энда, которые наиболее точно подходят под нашу задачу.

### Решение

Мы выбираем `Draw Flow` в качестве визуального редактора и `Zeebe` в качестве движка чат-ботов на бэк-энде.

### Статус

Решение принято. Мы открыты к альтернативам по мере их появления.

## Подробности

### Функционал движков. Основные моменты

Под задачами понимается service task (activity)

1. _Цепочки последовательных задач_. Настраивается границы транзакций, если одна задача завершилась с ошибкой можно гибко откатиться
2. _Разветвления_. Есть возможность пойти по той или по другой ветке
3. _Обработка исключений_. Если невозможно вернуть ответ, несколько раз делается повторы, кол-во повторов настраивается (retry).
4. _Таймеры_. Продвижение по процессу останавливается на 5 сек или 5 дней
5. _Пользовательские задачи_. Пример использования: чат-бот не помог пользователю. Создается задача в таск-листе на свободного менеджера. Менеджер берет задачу в работу и помогает пользователю. У менеджера повышается рейтинг (KPI). После чего управление передается чат-боту  
6. _Асинхронность._ Задачи выполняются асинхронно. Вторая может или дождаться завершения первой или протекать фоном

### Критерии выбора движка
1. Держит 1700 процессов (для каждой организации по 1) на каждую по 30 rps
2. Масштабируется по кол-ву процессов x10 и по rps x2
3. Высокая надежность решения
4. Процесс может длиться 3 месяца, например в сценарии с обучением менеджера 
5. По функционалу движка. Должен поддерживать цепочки последовательных задач, таймеры, разветвления
6. Поддерживает интеграцию с JS фреймворком для визуального программирования
7. Расширяемость (нуждается в уточнении)

### Рассмотренные альтернативы

1. [Camunda](https://camunda.com/)
2. [jBPM](https://www.jbpm.org/)
3. Serverless 1: [Amazon Lambda Step Functions](https://aws.amazon.com/ru/step-functions/), [Yandex Cloud Function](https://cloud.yandex.com/en-ru/services/functions). Требует от разработчика реализовать функции, выполняющие задачи и задать граф вычислений. Используется для оркестрации несложных stateless процессов в облаке.
4. Serverless 2: [Web-client](https://habr.com/ru/post/487340/). Внутри браузера. Сервер генерирует библиотеку, которая исполняется на клиенте (сами пользователи в настройках лендинга указывают путь к js–скрипту с библиотекой). Используется для конструирования чат-ботов для лендингов.
5. [Apache Camel](https://camel.apache.org/)
6. [Zebee](https://docs.camunda.io/docs/components/zeebe/zeebe-overview/)

### Аргументы
1. Поддерживает BPMN. Есть внутренний визуальный редактор. Пределы по масштабируемости из-за особенностей реализации. Выше производительность чем у Zebee, но медленнее Camel.
2. Поддерживает BPMN. Есть внутренний визуальный редактор. Аналогичен Camunda
3. Не поддерживает BPMN. Нет внутреннего визуального редактора. Cloud провайдер гарантирует порядок выполнения задач и задержки. Гарантируются надежность, эластичность и масштабируемость. Настройка процесса на стороне провайдера, из-за этого невозможна интеграция с внешним визуальным редактором
4. Не поддерживает BPMN. Простота интеграции с внешним визуальным редактором. Продолжительность процесса ограничена сроком жизни сессии web-браузера. Низкая стоимость
5. Не поддерживает BPMN. Нет внутреннего визуального редактора. Высокая производительность и масштабируемость (все процессы stateless). Нет пользовательских задач. В типичных сценариях время жизни процессов исчисляется секундами (вызовы веб-хуков). Но с другой стороны есть планировщик задач, в котором можно выставлять произвольные задержки
6. Поддерживает BPMN. Есть визуальный редактор. Высокая масштабируемость, которая практически ничем не ограничена. Низкая производительность. Требует быстрые жесткие диски (SSD). Сложнее настройка инфраструктуры. Высокая стоимость решения

### Выводы

* Нет простого способа интеграции с внешним визуальным редактором. Нужно разрабатывать свой формат
* На основании требования по масштабируемости, принято решение использовать Zeebe

## Выбор фреймворка фронт-енд

### Рассмотренные альтернативы

1. [Camunda Modeler](https://github.com/camunda/camunda-modeler)
2. [Flow Builder](https://github.com/bytedance/flow-builder)
3. [rete.js](https://github.com/retejs/rete)
4. [Draw Flow](https://github.com/jerosoler/Drawflow)


