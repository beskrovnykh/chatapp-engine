## Оглавление

### Контекст

Наши новые пользователи, хотят иметь возможность более гибко настраивать чат-ботов. Также у нас появляются новые пользователи, которые хотят иметь возможность встраивать чат-ботов в свои бизнес-процессы, сделанные в BPMN.
По этой причине мы хотим предоставить нашим пользователям возможность создавать чат-ботов визуально в нотации BPMN или аналогичной по содержанию

### Задача

Для этого нам нужно выбрать существующих фреймворки для бэк-энда и фронт-энда, которые наиболее точно подходят под нашу задачу

### Решение

Мы выбираем `Draw Flow` в качестве внешнего визуального редактора на фронт-энде и `Zeebe` в качестве движка чат-ботов на бэк-энде

### Статус

В процессе принятия решения, мы проверяем наши предположения

## Подробности

### Функционал движков. Основные моменты

Под задачами понимается activity

1. _Цепочки задач_. Настраиваются границы транзакций, если одна задача завершилась с ошибкой, то можно гибко откатиться
2. _Разветвления_. Есть возможность пойти по той или по другой ветке
3. _Обработка исключений_. Если невозможно вернуть ответ, делается несколько повторов. Кол-во повторов настраивается
4. _Таймеры_. Продвижение по процессу останавливается на 5 сек или 5 дней или более
5. _Пользовательские задачи_. Пример использования: чат-бот не помог пользователю. Создается задача в таск-листе на свободного менеджера. Менеджер берет задачу в работу и помогает пользователю. У менеджера повышается рейтинг (KPI). После чего управление передается чат-боту
6. _Асинхронность._ Задачи выполняются асинхронно. Вторая может или дождаться завершения первой или протекать фоном

### Критерии выбора движка
1. Приемлемая отзывчивость при 1700 процессах под нагрузкой 30 RPS
2. Масштабируется по кол-ву процессов x10 и по нагрузке x2
3. Высокая надежность решения
4. Процесс может длиться 3 месяца, например в сценарии с обучением менеджера
5. Можно выстраивать цепочки задач, добавлять таймеры, ветвления
6. Можно интегрироваться с внешним визуальным редактором

### Рассмотренные альтернативы

1. [Camunda](https://camunda.com/)
2. [jBPM](https://www.jbpm.org/)
3. Serverless 1: [Amazon Lambda Step Functions](https://aws.amazon.com/ru/step-functions/), [Yandex Cloud Function](https://cloud.yandex.com/en-ru/services/functions). Требует от разработчика реализовать функции, выполняющие задачи и задать граф вычислений. Используется для оркестрации несложных stateless процессов в облаке
4. Serverless 2: [Web-client](https://habr.com/ru/post/487340/). Внутри браузера. Сервер генерирует библиотеку, которая исполняется на клиенте (сами пользователи в настройках лендинга указывают путь к js–скрипту с библиотекой). Используется для конструирования чат-ботов для лендингов
5. [Apache Camel](https://camel.apache.org/)
6. [Zebee](https://docs.camunda.io/docs/components/zeebe/zeebe-overview/)

### Предположения
1. Процессы настолько "просты", что возможно написать конвертер для конвертации BPMN в формат данных пригодный для внешнего редактора
2. Процессы настолько "просты", что целевая пропускная способность и масштабируемость достижима
3. Формат данных не будет изменяться сильно, оставляя процессы в достаточной степени простыми

### Аргументы
1. Поддерживает BPMN. Есть внутренний визуальный редактор. Достижимы пределы по масштабируемости из-за особенностей реализации – единой базы данных. Выше производительность чем у Zeebe, но работает медленнее чем Apache Camel
2. Поддерживает BPMN. Есть внутренний визуальный редактор. Полностью аналогичен Camunda
3. Не поддерживает BPMN. Нет внутреннего визуального редактора. Облачный провайдер гарантирует порядок выполнения задач и задержки. Гарантируются надежность, эластичность и масштабируемость. Настройка процесса происходит на стороне провайдера, из-за этого невозможна интеграция с внешним визуальным редактором
4. Не поддерживает BPMN. Простота интеграции с внешним визуальным редактором. Продолжительность процесса ограничена сроком жизни сессии web-браузера. Низкая стоимость
5. Не поддерживает BPMN. Нет внутреннего визуального редактора. Высокая производительность и масштабируемость (все процессы stateless). Нет пользовательских задач. В типичных сценариях время жизни процессов исчисляется секундами (вызовы веб-хуков). С другой стороны есть планировщик задач, в котором можно выставлять произвольные задержки
6. Поддерживает BPMN. Есть визуальный редактор. Высокая масштабируемость, которая практически ничем не ограничена. Низкая производительность. Требует быстрые жесткие диски (SSD). Сложнее настройка инфраструктуры. Высокая стоимость

### Выводы

* Apache Camel выглядит лучшим решением, но он не имеет внутреннего визуального редактора, Zeebe не имеет границ по масштабируемости
* У всех движков нет простого способа интеграции с внешним визуальным редактором. Нужно разрабатывать свой формат

## Выбор фреймворка фронт-енд

### Рассмотренные альтернативы

1. [Camunda Modeler](https://github.com/camunda/camunda-modeler)
2. [Flow Builder](https://github.com/bytedance/flow-builder)
3. [rete.js](https://github.com/retejs/rete)
4. [Draw Flow](https://github.com/jerosoler/Drawflow)


